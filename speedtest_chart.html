<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Speedtest Chart</title>
    <!-- stylesheet cdns-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.default.css" integrity="sha512-J0JTRxsBEJ99DP4GamwciDi8VjALSrZneBYrv98BhqHPvlQP6gLbmmuddlYXHDB8hyLtefOIJFlpZBhksCtK8g==" crossorigin="anonymous" />
    <!-- script cdns -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/standalone/selectize.min.js" integrity="sha512-pF+DNRwavWMukUv/LyzDyDMn8U2uvqYQdJN0Zvilr6DDo/56xPDZdDoyPDYZRSL4aOKO/FGKXTpzDyQJ8je8Qw==" crossorigin="anonymous"></script>
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    
    <!-- local css -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="outerbox">
        <div class="row">
          <div class="col-sm">
            <canvas id="chart" width="1200" height="600"></canvas>
          </div>
        </div>
        <div class="row">
            <div class="col-sm">
                <div class="dropdown-div">
                    <select name="Time period" id="time_period" onchange="drawTimePeriod(value)">
                        <option value="12">1 hour</option> <!-- 6 items -->
                        <option value="36">3 hours</option>
                        <option value="72">6 hours</option>
                        <option value="144">12 hours</option>
                        <!-- <option value="432">1 day</option>
                        <option value="720">3 days</option>
                        <option value="1440">5 days</option> -->
                    </select>    
                </div>
            </div>   
        </div>
    </div>

    <script>

        // set up styles dropdown
        $(function() {
            $('select').selectize(
            {
                create: true,
            });    
        });

        // startWithDefault()

        function startWithDefault()
        {
            sixHours = 72;
            drawTimePeriod(sixHours);
            $('select').val(sixHours);
        }

        async function drawChartAsync(dataPoints) {
            const data = await getDataAsync(dataPoints);

            const ctx = document.getElementById('chart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.times,
                    datasets: [
                        {
                            label: 'Download',
                            data: data.downloads,
                            backgroundColor: 'rgba(164, 52, 235, 0.2)',
                            borderColor: 'rgba(164, 52, 235, 0.2)',
                            borderWidth: 1
                        },
                        {
                            label: 'Upload',
                            data: data.uploads,
                            backgroundColor: 'rgba(235, 158, 52, 0.2)',
                            borderColor: 'rgba(235, 158, 52)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                suggestedMax: 100
                            }
                        }],
                    }
                }
            });
        }

        async function getDataAsync(dataPoints) {
            const times = [];
            const downloads = [];
            const uploads = [];

            const response = await fetch('output.csv');
            const data = await response.text();
            table = data.split('\n').slice(1); // remove header
            table = table.slice(0, (table.length - 1)) //remove trailing empty line
            table = table.reverse();
            table = table.slice(0, dataPoints); // get segment

            const mbSpeedRegex = /[0-9]*[0-9].[0-9][0-9]/s
            table.forEach(row => {
                const rowArray = row.split(',');
                const time = rowArray[0].slice(12, 17);
                times.push(time);
                downloads.push(rowArray[1].match(mbSpeedRegex));
                uploads.push(rowArray[2].match(mbSpeedRegex));

            })
            times.reverse();
            downloads.reverse();
            uploads.reverse();
            return { times, downloads, uploads }
        }

        function drawTimePeriod($period)
        {
            drawChartAsync($period)
        }

    </script>
</body>

</html>